name: Unified Monorepo Deployment

on:
  push:
    branches: [master]
    paths:
      - 'HousingUtilitiesSystemAdmin/**'
      - 'HousingUtilitiesSystemChairman/**'
      - 'HousingUtilitiesSystemUser/**'
      - 'pom.xml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  DOCKER_REGISTRY: ghcr.io
  NETWORK_NAME: housing-network
  MONGO_KEYFILE: /opt/mongo/keyfile

jobs:
  # ============================================================================
  # Admin Module Deployment
  # ============================================================================
  admin:
    name: Deploy Admin
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '[all]') ||
      contains(github.event.head_commit.modified, 'HousingUtilitiesSystemAdmin/') ||
      contains(github.event.head_commit.modified, 'pom.xml')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build Admin
        run: mvn clean verify -B -pl HousingUtilitiesSystemAdmin -am

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./HousingUtilitiesSystemAdmin
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/housing-utilities-admin:latest

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e
            CONTAINER="housing-utilities-admin"
            IMAGE="${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/housing-utilities-admin:latest"
            
            # Shared Infra Check
            docker network create ${{ env.NETWORK_NAME }} 2>/dev/null || true
            
            # Pull and Restart App
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ${{ env.DOCKER_REGISTRY }} -u ${{ github.actor }} --password-stdin
            docker pull $IMAGE
            docker stop $CONTAINER 2>/dev/null || true
            docker rm $CONTAINER 2>/dev/null || true
            
            docker run -d \
              --name $CONTAINER \
              --network ${{ env.NETWORK_NAME }} \
              --restart unless-stopped \
              -p 9081:8080 \
              -e MONGODB_URI='mongodb://${{ secrets.MONGO_ROOT_USERNAME }}:${{ secrets.MONGO_ROOT_PASSWORD }}@mongo1-housing:27017,mongo2-housing:27017,mongo3-housing:27017/HousingUtilitiesSystemDB?replicaSet=rs0&authSource=admin' \
              -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
              -e OAUTH_GOOGLE_CLIENT_ID='${{ secrets.OAUTH_GOOGLE_CLIENT_ID }}' \
              -e OAUTH_GOOGLE_CLIENT_SECRET='${{ secrets.OAUTH_GOOGLE_CLIENT_SECRET }}' \
              -e SENDGRID_API_KEY='${{ secrets.SENDGRID_API_KEY }}' \
              -e SENDGRID_FROM_EMAIL='${{ secrets.SENDGRID_FROM_EMAIL }}' \
              -e MAIL_USERNAME='${{ secrets.MAIL_USERNAME }}' \
              -e MAIL_PASSWORD='${{ secrets.MAIL_PASSWORD }}' \
              -e ELASTICSEARCH_URIS="http://elasticsearch-housing:9200" \
              -e SPRING_DATA_REDIS_HOST="redis-housing" \
              -e SPRING_PROFILES_ACTIVE="docker" \
              -v /opt/housing-uploads:/app/uploads \
              $IMAGE

  # ============================================================================
  # Chairman Module Deployment
  # ============================================================================
  chairman:
    name: Deploy Chairman
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '[all]') ||
      contains(github.event.head_commit.modified, 'HousingUtilitiesSystemChairman/') ||
      contains(github.event.head_commit.modified, 'pom.xml')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build Chairman
        run: mvn clean verify -B -pl HousingUtilitiesSystemChairman -am

      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./HousingUtilitiesSystemChairman
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/housing-utilities-chairman:latest

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e
            CONTAINER="housing-utilities-chairman"
            IMAGE="${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/housing-utilities-chairman:latest"
            
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ${{ env.DOCKER_REGISTRY }} -u ${{ github.actor }} --password-stdin
            docker pull $IMAGE
            docker stop $CONTAINER 2>/dev/null || true
            docker rm $CONTAINER 2>/dev/null || true
            
            docker run -d \
              --name $CONTAINER \
              --network ${{ env.NETWORK_NAME }} \
              --restart unless-stopped \
              -p 9083:8082 \
              -e MONGODB_URI='mongodb://${{ secrets.MONGO_ROOT_USERNAME }}:${{ secrets.MONGO_ROOT_PASSWORD }}@mongo1-housing:27017,mongo2-housing:27017,mongo3-housing:27017/HousingUtilitiesSystemDB?replicaSet=rs0&authSource=admin' \
              -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
              -e OAUTH_GOOGLE_CLIENT_ID='${{ secrets.OAUTH_GOOGLE_CLIENT_ID }}' \
              -e OAUTH_GOOGLE_CLIENT_SECRET='${{ secrets.OAUTH_GOOGLE_CLIENT_SECRET }}' \
              -e SENDGRID_API_KEY='${{ secrets.SENDGRID_API_KEY }}' \
              -e SENDGRID_FROM_EMAIL='${{ secrets.SENDGRID_FROM_EMAIL }}' \
              -e MAIL_USERNAME='${{ secrets.MAIL_USERNAME }}' \
              -e MAIL_PASSWORD='${{ secrets.MAIL_PASSWORD }}' \
              -e ELASTICSEARCH_URIS="http://elasticsearch-housing:9200" \
              -e SPRING_DATA_REDIS_HOST="redis-housing" \
              -e SPRING_PROFILES_ACTIVE="docker" \
              -v /opt/housing-uploads:/app/uploads \
              $IMAGE

  # ============================================================================
  # User Module Deployment
  # ============================================================================
  user:
    name: Deploy User
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '[all]') ||
      contains(github.event.head_commit.modified, 'HousingUtilitiesSystemUser/') ||
      contains(github.event.head_commit.modified, 'pom.xml')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build User
        run: mvn clean verify -B -pl HousingUtilitiesSystemUser -am

      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./HousingUtilitiesSystemUser
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/housing-utilities-user:latest

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e
            CONTAINER="housing-utilities-user"
            IMAGE="${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/housing-utilities-user:latest"
            
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ${{ env.DOCKER_REGISTRY }} -u ${{ github.actor }} --password-stdin
            docker pull $IMAGE
            docker stop $CONTAINER 2>/dev/null || true
            docker rm $CONTAINER 2>/dev/null || true
            
            docker run -d \
              --name $CONTAINER \
              --network ${{ env.NETWORK_NAME }} \
              --restart unless-stopped \
              -p 9082:8081 \
              -e MONGODB_URI='mongodb://${{ secrets.MONGO_ROOT_USERNAME }}:${{ secrets.MONGO_ROOT_PASSWORD }}@mongo1-housing:27017,mongo2-housing:27017,mongo3-housing:27017/HousingUtilitiesSystemDB?replicaSet=rs0&authSource=admin' \
              -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
              -e OAUTH_GOOGLE_CLIENT_ID='${{ secrets.OAUTH_GOOGLE_CLIENT_ID }}' \
              -e OAUTH_GOOGLE_CLIENT_SECRET='${{ secrets.OAUTH_GOOGLE_CLIENT_SECRET }}' \
              -e SENDGRID_API_KEY='${{ secrets.SENDGRID_API_KEY }}' \
              -e SENDGRID_FROM_EMAIL='${{ secrets.SENDGRID_FROM_EMAIL }}' \
              -e MAIL_USERNAME='${{ secrets.MAIL_USERNAME }}' \
              -e MAIL_PASSWORD='${{ secrets.MAIL_PASSWORD }}' \
              -e ELASTICSEARCH_URIS="http://elasticsearch-housing:9200" \
              -e SPRING_DATA_REDIS_HOST="redis-housing" \
              -e SPRING_PROFILES_ACTIVE="docker" \
              -v /opt/housing-uploads:/app/uploads \
              $IMAGE
