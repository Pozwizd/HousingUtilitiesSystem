<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{template/layout.html}">

<head>
    <title data-i18n="contacts.title">Контакты</title>
    <th:block layout:fragment="page_css">
        <style>
            .section-card {
                border: 1px solid var(--bs-border-color);
                border-radius: 8px;
                margin-bottom: 20px;
                padding: 20px;
                background: var(--bs-card-bg);
            }

            .section-header {
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 1px solid var(--bs-border-color);
            }

            .section-title {
                font-size: 1.25rem;
                font-weight: 600;
                margin: 0;
                color: var(--bs-body-color);
            }

            .section-content {
                margin-bottom: 20px;
                color: var(--bs-secondary-color);
            }

            .contact-card {
                display: flex;
                gap: 15px;
                padding: 15px;
                border: 1px solid var(--bs-border-color);
                border-radius: 8px;
                margin-bottom: 10px;
                background: var(--bs-tertiary-bg);
            }

            .contact-photo {
                width: 100px;
                height: 100px;
                border-radius: 8px;
                object-fit: cover;
                background: var(--bs-secondary-bg);
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--bs-secondary-color);
                font-size: 0.75rem;
                flex-shrink: 0;
            }

            .contact-photo img {
                width: 100%;
                height: 100%;
                border-radius: 8px;
                object-fit: cover;
            }

            .contact-info {
                flex: 1;
            }

            .contact-name {
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--bs-body-color);
                margin-bottom: 5px;
            }

            .contact-role {
                color: var(--bs-success);
                font-size: 0.9rem;
                margin-bottom: 3px;
            }

            .contact-phone {
                color: var(--bs-primary);
                font-size: 0.9rem;
                margin-bottom: 5px;
            }

            .contact-phone a {
                color: var(--bs-primary);
                text-decoration: none;
            }

            .contact-phone a:hover {
                text-decoration: underline;
            }

            .contact-description {
                color: var(--bs-secondary-color);
                font-size: 0.85rem;
                line-height: 1.4;
            }

            .empty-state {
                text-align: center;
                padding: 40px;
                color: var(--bs-secondary-color);
            }

            .empty-state i {
                font-size: 3rem;
                margin-bottom: 15px;
                opacity: 0.5;
            }
        </style>
    </th:block>
</head>

<body>

    <div layout:fragment="content">
        <div class="main-card mb-3 card" id="card-block">
            <div class="card-header">
                <h5 class="mb-0">Контакты</h5>
            </div>
            <div class="card-body" id="sectionsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="page_js">
        <script th:inline="javascript">
            window.contextPath = '[[@{/}]]'.replaceAll('"', '').replace(/\/$/, '');
        </script>
        <script>
            $(document).ready(function () {
                loadSections();
            });

            function loadSections() {
                $.ajax({
                    url: window.contextPath + '/contacts/api/sections',
                    type: 'GET',
                    success: function (sections) {
                        const container = $('#sectionsContainer');
                        container.empty();

                        if (sections && sections.length > 0) {
                            sections.forEach(section => {
                                const sectionEl = createSectionElement(section);
                                container.append(sectionEl);
                            });
                        } else {
                            container.html(`
                                <div class="empty-state">
                                    <i class="icon-base ti tabler-address-book"></i>
                                    <p>Контакты пока не добавлены</p>
                                </div>
                            `);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error loading sections:', error);
                        $('#sectionsContainer').html(`
                            <div class="empty-state">
                                <i class="icon-base ti tabler-alert-circle"></i>
                                <p>Ошибка загрузки контактов</p>
                            </div>
                        `);
                    }
                });
            }

            function createSectionElement(section) {
                const sectionCard = $('<div class="section-card"></div>');

                // Section header
                if (section.title) {
                    sectionCard.append(`
                        <div class="section-header">
                            <h6 class="section-title">${escapeHtml(section.title)}</h6>
                        </div>
                    `);
                }

                // Section content
                if (section.content) {
                    sectionCard.append(`<div class="section-content">${section.content}</div>`);
                }

                // Contacts
                if (section.contacts && section.contacts.length > 0) {
                    section.contacts.forEach(contact => {
                        const contactEl = createContactElement(contact);
                        sectionCard.append(contactEl);
                    });
                }

                return sectionCard;
            }

            function createContactElement(contact) {
                const contactCard = $('<div class="contact-card"></div>');

                // Photo
                let photoHtml = '';
                if (contact.photoPath) {
                    photoHtml = `
                        <div class="contact-photo">
                            <img src="${window.contextPath}/${contact.photoPath}" alt="${escapeHtml(contact.fullName || '')}">
                        </div>
                    `;
                } else {
                    photoHtml = `
                        <div class="contact-photo">
                            <i class="icon-base ti tabler-user" style="font-size: 2rem;"></i>
                        </div>
                    `;
                }
                contactCard.append(photoHtml);

                // Info
                let infoHtml = '<div class="contact-info">';

                if (contact.fullName) {
                    infoHtml += `<div class="contact-name">${escapeHtml(contact.fullName)}</div>`;
                }

                if (contact.role) {
                    infoHtml += `<div class="contact-role">${escapeHtml(contact.role)}</div>`;
                }

                if (contact.phone) {
                    infoHtml += `<div class="contact-phone"><a href="tel:${escapeHtml(contact.phone)}">${escapeHtml(contact.phone)}</a></div>`;
                }

                if (contact.description) {
                    infoHtml += `<div class="contact-description">${escapeHtml(contact.description)}</div>`;
                }

                infoHtml += '</div>';
                contactCard.append(infoHtml);

                return contactCard;
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        </script>
    </th:block>

</body>

</html>