<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="http://www.thymeleaf.org"
    layout:decorate="~{template/layout}">

<head>
    <title>Новое сообщение</title>
    <th:block layout:fragment="page_css">
    </th:block>
</head>

<body>
    <div layout:fragment="content" class="container-xxl flex-grow-1 container-p-y">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Новое сообщение</h5>
                        <a th:href="@{/requests/}" class="btn btn-label-secondary">
                            <i class="icon-base ti tabler-arrow-left me-1"></i>
                            Назад
                        </a>
                    </div>
                    <div class="card-body">
                        <form id="feedbackForm">
                            <div class="mb-4">
                                <label for="subjectInput" class="form-label">Тема сообщения</label>
                                <input type="text" id="subjectInput" class="form-control"
                                    placeholder="Введите тему сообщения" required>
                            </div>

                            <div class="mb-4">
                                <label for="messageInput" class="form-label">Текст сообщения</label>
                                <textarea id="messageInput" class="form-control" rows="8"
                                    placeholder="Введите текст сообщения" required></textarea>
                            </div>

                            <div class="d-flex justify-content-end gap-3">
                                <a th:href="@{/requests/}" class="btn btn-label-secondary">Отменить</a>
                                <button type="submit" class="btn btn-primary" id="sendBtn">
                                    <i class="icon-base ti tabler-send me-1"></i>
                                    Отправить
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="page_js">
        <script th:inline="javascript">
            window.contextPath = '[[@{/}]]'.replaceAll('"', '').replace(/\/$/, '');
        </script>
        <script>
            $(document).ready(function () {
                $('#feedbackForm').submit(function (e) {
                    e.preventDefault();

                    const subject = $('#subjectInput').val().trim();
                    const message = $('#messageInput').val().trim();

                    if (!subject) {
                        showAlert('Введите тему сообщения', 'warning');
                        return;
                    }

                    if (!message) {
                        showAlert('Введите текст сообщения', 'warning');
                        return;
                    }

                    $('#sendBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span> Отправка...');

                    $.ajax({
                        url: window.contextPath + '/api/requests',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            subject: subject,
                            message: message
                        }),
                        success: function (response) {
                            showAlert('Сообщение отправлено!', 'success');
                            window.location.href = window.contextPath + '/requests/';
                        },
                        error: function (xhr, status, error) {
                            console.error('Error creating request:', error);
                            showAlert('Ошибка отправки сообщения', 'error');
                            $('#sendBtn').prop('disabled', false).html('<i class="icon-base ti tabler-send me-1"></i> Отправить');
                        }
                    });
                });
            });
        </script>
    </th:block>
</body>

</html>