<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{template/layout.html}">

<head>
    <th:block layout:fragment="page_css">
        <style>
            .badge-active {
                background-color: #28a745;
                color: white;
            }

            .badge-closed {
                background-color: #6c757d;
                color: white;
            }

            .badge-accepted {
                background-color: #28a745;
                color: white;
            }

            .badge-rejected {
                background-color: #dc3545;
                color: white;
            }

            .votes-info {
                font-size: 0.875rem;
            }

            .votes-info .for {
                color: #28a745;
                font-weight: bold;
            }

            .votes-info .against {
                color: #dc3545;
                font-weight: bold;
            }

            .votes-info .abstain {
                color: #6c757d;
                font-weight: bold;
            }
        </style>
    </th:block>
</head>

<body>

    <div layout:fragment="content">
        <div class="main-card mb-3 card" id="card-block">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" data-i18n="votes.title">Голосования</h5>
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#voteModal"
                    id="createVoteBtn">
                    <i class="icon-base ti tabler-plus me-1"></i>
                    <span data-i18n="common.create">Создать</span>
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table style="width: 100%;" class="table table-hover table-striped table-bordered">
                        <thead>
                            <tr>
                                <th data-i18n="votes.topic">Тема голосования</th>
                                <th data-i18n="votes.endTime">Время завершения</th>
                                <th data-i18n="common.status">Статус</th>
                                <th data-i18n="votes.result">Результат</th>
                                <th data-i18n="votes.voted">Проголосовало, кв. м.</th>
                                <th data-i18n="common.actions">Действия</th>
                            </tr>
                            <!-- Filter Row -->
                            <tr>
                                <th><input type="text" class="form-control form-control-sm filter-input"
                                        data-filter-key="title" data-i18n="[placeholder]votes.topic" placeholder="Тема">
                                </th>
                                <th></th>
                                <th>
                                    <select class="form-select form-select-sm filter-select" data-filter-key="status">
                                        <option value="" data-i18n="common.all">Все</option>
                                        <option value="Активное" data-i18n="votes.statusActive">Активное</option>
                                        <option value="Закрыто" data-i18n="votes.statusClosed">Закрыто</option>
                                    </select>
                                </th>
                                <th>
                                    <select class="form-select form-select-sm filter-select" data-filter-key="result">
                                        <option value="" data-i18n="common.all">Все</option>
                                        <option value="Принято" data-i18n="votes.resultAccepted">Принято</option>
                                        <option value="Отклонено" data-i18n="votes.resultRejected">Отклонено</option>
                                    </select>
                                </th>
                                <th></th>
                                <th class="text-center">
                                    <button type="button" id="clearFiltersBtn" class="btn btn-light btn-sm"
                                        data-i18n="common.clear">Очистить</button>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="voteTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center py-3">
                <label class="d-flex align-items-center gap-1 mb-0">
                    <select id="pageSize" class="custom-select custom-select-sm form-control form-control-sm mx-2"
                        style="width: auto;">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </label>
                <nav aria-label="Pagination">
                    <ul class="pagination mb-0" id="pagination">
                    </ul>
                </nav>
            </div>

            <!-- Delete Confirmation Modal -->
            <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" data-i18n="common.confirmDelete">Подтверждение удаления</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Закрыть"></button>
                        </div>
                        <div class="modal-body">
                            <span data-i18n="votes.deleteConfirm">Вы уверены, что хотите удалить это голосование?</span>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal"
                                data-i18n="common.cancel">Отменить</button>
                            <button type="button" class="btn btn-danger" id="confirm-delete-btn"
                                data-i18n="common.delete">Удалить</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create/Edit Vote Modal -->
            <div class="modal fade" id="voteModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-primary">
                            <h5 class="modal-title text-white" id="voteModalLabel" data-i18n="votes.newVote">Новое
                                голосование</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Закрыть"></button>
                        </div>
                        <div class="modal-body">
                            <form id="voteForm">
                                <input type="hidden" id="voteId">
                                <div class="mb-3">
                                    <label for="voteTitle" class="form-label" data-i18n="votes.topic">Тема
                                        голосования</label>
                                    <input type="text" class="form-control" id="voteTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="voteDescription" class="form-label" data-i18n="votes.description">Текст
                                        голосования</label>
                                    <textarea class="form-control" id="voteDescription" rows="4"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="voteStartTime" class="form-label" data-i18n="votes.startTime">Время
                                            начала</label>
                                        <input type="datetime-local" class="form-control" id="voteStartTime">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="voteEndTime" class="form-label" data-i18n="votes.endTime">Время
                                            завершения</label>
                                        <input type="datetime-local" class="form-control" id="voteEndTime">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="voteQuorum" class="form-label" data-i18n="votes.quorum">Кворум, кв.
                                            м.</label>
                                        <input type="number" step="0.01" class="form-control" id="voteQuorum">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="voteStatus" class="form-label" data-i18n="common.status">Статус</label>
                                    <select class="form-select" id="voteStatus">
                                        <option value="Активное" data-i18n="votes.statusActive">Активное</option>
                                        <option value="Закрыто" data-i18n="votes.statusClosed">Закрыто</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal"
                                data-i18n="common.cancel">Отменить</button>
                            <button type="button" class="btn btn-success" id="saveVoteBtn"
                                data-i18n="common.save">Сохранить</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div>
        <th:block layout:fragment="page_js">
            <script th:inline="javascript">
                window.contextPath = '[[@{/}]]'.replaceAll('"', '').replace(/\/$/, '');
            </script>
            <script>
                $(document).ready(function () {
                    let currentPage = 0;
                    let pageSize = 10;
                    let currentFilters = {};
                    let isEditMode = false;

                    function loadVoteTable() {
                        const requestData = {
                            page: currentPage,
                            size: pageSize
                        };

                        Object.keys(currentFilters).forEach(key => {
                            if (currentFilters[key]) {
                                requestData[key] = currentFilters[key];
                            }
                        });

                        $.ajax({
                            url: window.contextPath + '/voting/getAll',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(requestData),
                            success: function (response) {
                                renderTable(response.content);
                                renderPagination(response);
                            },
                            error: function (xhr, status, error) {
                                console.error('Error loading data:', error);
                            }
                        });
                    }

                    function renderTable(votes) {
                        const tbody = $('#voteTableBody');
                        tbody.empty();

                        if (!votes || votes.length === 0) {
                            tbody.append(`
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <i class="icon-base ti tabler-mood-empty icon-lg mb-2"></i>
                                    <p class="mb-0">Голосования не найдены</p>
                                </td>
                            </tr>
                        `);
                            return;
                        }

                        votes.forEach(vote => {
                            const endDate = vote.endTime ? new Date(vote.endTime).toLocaleString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '-';

                            const statusBadge = vote.status === 'Активное'
                                ? '<span class="badge badge-active">Активное</span>'
                                : '<span class="badge badge-closed">Закрыто</span>';

                            let resultBadge = '-';
                            if (vote.result === 'Принято') {
                                resultBadge = '<span class="badge badge-accepted">Принято</span>';
                            } else if (vote.result === 'Отклонено') {
                                resultBadge = '<span class="badge badge-rejected">Отклонено</span>';
                            }

                            const votesInfo = `<span class="votes-info">
                            <span class="for">${vote.forVotesCount || 0}</span> / 
                            <span class="against">${vote.againstVotesCount || 0}</span> / 
                            <span class="abstain">${vote.abstentionsCount || 0}</span>
                        </span>`;

                            const row = `
                            <tr>
                                <td>${vote.title || '-'}</td>
                                <td>${endDate}</td>
                                <td>${statusBadge}</td>
                                <td>${resultBadge}</td>
                                <td>${votesInfo}</td>
                                <td class="text-center">
                                    <div class="dropdown">
                                        <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                                          <i class="icon-base ti tabler-dots-vertical"></i>
                                        </button>
                                        <div class="dropdown-menu">
                                              <a href="${window.contextPath}/voting/${vote.id}/view" class="dropdown-item"><i
                                                  class="icon-base ti tabler-eye me-1"></i> <span data-i18n="common.view">Просмотреть</span></a>
                                              <button class="dropdown-item edit-btn" data-id="${vote.id}"><i
                                                  class="icon-base ti tabler-pencil me-1"></i> <span data-i18n="common.edit">Редактировать</span></button>
                                              <button class="dropdown-item delete-btn" data-id="${vote.id}"><i
                                                  class="icon-base ti tabler-trash me-1"></i> <span data-i18n="common.delete">Удалить</span></button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                            tbody.append(row);
                        });
                    }

                    function renderPagination(pageData) {
                        const pagination = $('#pagination');
                        pagination.empty();

                        const totalPages = pageData.totalPages;
                        const currentPageNum = pageData.number;

                        if (totalPages <= 1) return;

                        // First button
                        const firstDisabled = currentPageNum === 0 ? 'disabled' : '';
                        pagination.append(`
                        <li class="page-item ${firstDisabled}">
                            <a class="page-link" href="#" data-page="0">
                                <i class="icon-base ti tabler-chevrons-left icon-sm"></i>
                            </a>
                        </li>
                    `);

                        // Previous button
                        const prevDisabled = currentPageNum === 0 ? 'disabled' : '';
                        pagination.append(`
                        <li class="page-item ${prevDisabled}">
                            <a class="page-link" href="#" data-page="${currentPageNum - 1}">
                                <i class="icon-base ti tabler-chevron-left icon-sm"></i>
                            </a>
                        </li>
                    `);

                        // Page numbers
                        let startPage = Math.max(0, currentPageNum - 2);
                        let endPage = Math.min(totalPages - 1, currentPageNum + 2);

                        for (let i = startPage; i <= endPage; i++) {
                            const activeClass = i === currentPageNum ? 'active' : '';
                            pagination.append(`
                            <li class="page-item ${activeClass}">
                                <a class="page-link" href="#" data-page="${i}">${i + 1}</a>
                            </li>
                        `);
                        }

                        // Next button
                        const nextDisabled = currentPageNum >= totalPages - 1 ? 'disabled' : '';
                        pagination.append(`
                        <li class="page-item ${nextDisabled}">
                            <a class="page-link" href="#" data-page="${currentPageNum + 1}">
                                <i class="icon-base ti tabler-chevron-right icon-sm"></i>
                            </a>
                        </li>
                    `);

                        // Last button
                        const lastDisabled = currentPageNum >= totalPages - 1 ? 'disabled' : '';
                        pagination.append(`
                        <li class="page-item ${lastDisabled}">
                            <a class="page-link" href="#" data-page="${totalPages - 1}">
                                <i class="icon-base ti tabler-chevrons-right icon-sm"></i>
                            </a>
                        </li>
                    `);
                    }

                    // Pagination click
                    $(document).on('click', '.page-link', function (e) {
                        e.preventDefault();
                        if ($(this).parent().hasClass('disabled')) return;
                        currentPage = parseInt($(this).data('page'));
                        loadVoteTable();
                    });

                    // Page size change
                    $('#pageSize').change(function () {
                        pageSize = parseInt($(this).val());
                        currentPage = 0;
                        loadVoteTable();
                    });

                    // Text filters
                    $('.filter-input').on('input', function () {
                        const filterKey = $(this).data('filter-key');
                        const filterValue = $(this).val();

                        if (filterValue) {
                            currentFilters[filterKey] = filterValue;
                        } else {
                            delete currentFilters[filterKey];
                        }

                        currentPage = 0;
                        loadVoteTable();
                    });

                    // Select filters
                    $('.filter-select').on('change', function () {
                        const filterKey = $(this).data('filter-key');
                        const filterValue = $(this).val();

                        if (filterValue) {
                            currentFilters[filterKey] = filterValue;
                        } else {
                            delete currentFilters[filterKey];
                        }

                        currentPage = 0;
                        loadVoteTable();
                    });

                    // Clear filters
                    $('#clearFiltersBtn').click(function () {
                        $('.filter-input').val('');
                        $('.filter-select').val('');
                        currentFilters = {};
                        currentPage = 0;
                        loadVoteTable();
                    });

                    // Create button click
                    $('#createVoteBtn').click(function () {
                        isEditMode = false;
                        $('#voteModalLabel').text('Новое голосование');
                        $('#voteForm')[0].reset();
                        $('#voteId').val('');
                    });

                    // Edit button click
                    $(document).on('click', '.edit-btn', function () {
                        const voteId = $(this).data('id');
                        isEditMode = true;
                        $('#voteModalLabel').text('Редактировать голосование');

                        $.ajax({
                            url: window.contextPath + '/voting/' + voteId,
                            type: 'GET',
                            success: function (vote) {
                                $('#voteId').val(vote.id);
                                $('#voteTitle').val(vote.title);
                                $('#voteDescription').val(vote.description || '');
                                if (vote.startTime) {
                                    $('#voteStartTime').val(new Date(vote.startTime).toISOString().slice(0, 16));
                                }
                                if (vote.endTime) {
                                    $('#voteEndTime').val(new Date(vote.endTime).toISOString().slice(0, 16));
                                }
                                $('#voteQuorum').val(vote.quorumArea || '');
                                $('#voteStatus').val(vote.status || 'Активное');
                                $('#voteModal').modal('show');
                            },
                            error: function (xhr, status, error) {
                                console.error('Error loading vote:', error);
                            }
                        });
                    });

                    // Save vote
                    $('#saveVoteBtn').click(function () {
                        const voteData = {
                            title: $('#voteTitle').val(),
                            description: $('#voteDescription').val(),
                            startTime: $('#voteStartTime').val() ? new Date($('#voteStartTime').val()).toISOString() : null,
                            endTime: $('#voteEndTime').val() ? new Date($('#voteEndTime').val()).toISOString() : null,
                            quorumArea: $('#voteQuorum').val() ? parseFloat($('#voteQuorum').val()) : null,
                            status: $('#voteStatus').val()
                        };

                        const voteId = $('#voteId').val();
                        const url = isEditMode
                            ? window.contextPath + '/voting/' + voteId
                            : window.contextPath + '/voting/create';
                        const method = isEditMode ? 'PUT' : 'POST';

                        $.ajax({
                            url: url,
                            type: method,
                            contentType: 'application/json',
                            data: JSON.stringify(voteData),
                            success: function (response) {
                                $('#voteModal').modal('hide');
                                loadVoteTable();
                            },
                            error: function (xhr, status, error) {
                                console.error('Error saving vote:', error);
                            }
                        });
                    });

                    // Delete button click
                    $(document).on('click', '.delete-btn', function () {
                        const voteId = $(this).data('id');
                        $('#confirm-delete-btn').data('id', voteId);
                        $('#deleteConfirmModal').modal('show');
                    });

                    // Confirm delete
                    $('#confirm-delete-btn').click(function () {
                        const voteId = $(this).data('id');

                        $.ajax({
                            url: window.contextPath + '/voting/' + voteId,
                            type: 'DELETE',
                            success: function () {
                                $('#deleteConfirmModal').modal('hide');
                                loadVoteTable();
                            },
                            error: function (xhr, status, error) {
                                console.error('Delete error:', error);
                                $('#deleteConfirmModal').modal('hide');
                            }
                        });
                    });

                    // Initial load
                    loadVoteTable();
                });
            </script>
        </th:block>
    </div>

</body>

</html>