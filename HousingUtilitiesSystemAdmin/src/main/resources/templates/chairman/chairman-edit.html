<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{template/layout.html}">

<head>
    <th:block layout:fragment="page_css">

    </th:block>
</head>

<body>

    <div layout:fragment="content">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-6">
                    <h5 class="card-header" id="pageTitle" data-i18n="chairmen.newChairman">Новый председатель</h5>
                    <form id="formAccountSettings" enctype="multipart/form-data">
                        <!-- Account -->
                        <div class="card-body">
                            <div class="d-flex align-items-start align-items-sm-center gap-6">
                                <img th:src="@{/assets/img/avatars/1.png}" alt="chairman-avatar"
                                    class="d-block w-px-100 h-px-100 rounded" id="uploadedAvatar" />
                                <div class="button-wrapper">
                                    <label for="photo" class="btn btn-primary me-3 mb-4" tabindex="0">
                                        <span class="d-none d-sm-block" data-i18n="users.uploadPhoto">Загрузить
                                            фото</span>
                                        <i class="icon-base ti tabler-upload d-block d-sm-none"></i>
                                        <input type="file" id="photo" name="photoFile" class="account-file-input" hidden
                                            accept="image/png, image/jpeg, image/jpg, image/gif" />
                                    </label>
                                    <button type="button" class="btn btn-label-secondary account-image-reset mb-4">
                                        <i class="icon-base ti tabler-reset d-block d-sm-none"></i>
                                        <span class="d-none d-sm-block" data-i18n="users.reset">Сбросить</span>
                                    </button>

                                    <div data-i18n="users.allowedFormats">Разрешены JPG, GIF или PNG. Максимальный
                                        размер 800K</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body pt-4">

                            <input type="hidden" id="chairmanId" name="id" />
                            <div class="row gy-4 gx-6 mb-3">
                                <!-- Фамилия -->
                                <div class="col-md-6">
                                    <label for="lastName" class="form-label"><span
                                            data-i18n="users.lastName">Фамилия</span> <span
                                            class="text-danger">*</span></label>
                                    <input class="form-control" type="text" name="lastName" id="lastName"
                                        data-i18n="[placeholder]users.placeholders.enterLastName"
                                        placeholder="Введите фамилию" />
                                    <div class="invalid-feedback"></div>
                                </div>

                                <!-- Имя -->
                                <div class="col-md-6">
                                    <label for="firstName" class="form-label"><span
                                            data-i18n="users.firstName">Имя</span> <span
                                            class="text-danger">*</span></label>
                                    <input class="form-control" type="text" name="firstName" id="firstName"
                                        data-i18n="[placeholder]users.placeholders.enterFirstName"
                                        placeholder="Введите имя" autofocus />
                                    <div class="invalid-feedback"></div>
                                </div>

                                <!-- Отчество -->
                                <div class="col-md-6">
                                    <label for="middleName" class="form-label"
                                        data-i18n="users.middleName">Отчество</label>
                                    <input class="form-control" type="text" name="middleName" id="middleName"
                                        data-i18n="[placeholder]users.placeholders.enterMiddleName"
                                        placeholder="Введите отчество" />
                                    <div class="invalid-feedback"></div>
                                </div>

                                <!-- Телефон -->
                                <div class="col-md-6">
                                    <label class="form-label" for="phone"><span data-i18n="users.phone">Телефон</span>
                                        <span class="text-danger">*</span></label>
                                    <input type="tel" name="phone" id="phone" class="form-control"
                                        data-i18n="[placeholder]users.placeholders.enterPhone"
                                        placeholder="+380501234567" />
                                    <div class="invalid-feedback"></div>
                                </div>

                                <!-- Email -->
                                <div class="col-md-6">
                                    <label for="email" class="form-label"><span data-i18n="users.email">E-mail</span>
                                        <span class="text-danger">*</span></label>
                                    <input class="form-control" type="text" name="email" id="email"
                                        data-i18n="[placeholder]users.placeholders.enterEmail"
                                        placeholder="example@domain.com" />
                                    <div class="invalid-feedback"></div>
                                </div>

                                <!-- Статус -->
                                <div class="col-md-6">
                                    <label for="status" class="form-label"><span data-i18n="common.status">Статус</span>
                                        <span class="text-danger">*</span></label>
                                    <select name="status" id="status" class="form-select">
                                        <option value="" data-i18n="chairmen.placeholders.selectStatus">Выберите статус
                                        </option>
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <hr class="my-12" />
                            <!-- Секция: Данные для входа -->
                            <div class="form-section">
                                <h6 data-i18n="users.loginData">Данные для входа</h6>
                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <label for="login" class="form-label"><span data-i18n="users.login">Логин</span>
                                            <span class="text-danger">*</span></label>
                                        <input class="form-control" type="text" name="login" id="login"
                                            data-i18n="[placeholder]users.placeholders.enterLogin"
                                            placeholder="Введите логин" />
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="password" class="form-label"><span
                                                data-i18n="users.password">Пароль</span> <span
                                                class="text-danger">*</span></label>
                                        <input class="form-control" type="password" name="password" id="password"
                                            data-i18n="[placeholder]users.placeholders.enterPassword"
                                            placeholder="••••••••" />
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="repeatPassword" class="form-label"><span
                                                data-i18n="users.repeatPassword">Повторить пароль</span> <span
                                                class="text-danger">*</span></label>
                                        <input class="form-control" type="password" name="repeatPassword"
                                            id="repeatPassword"
                                            data-i18n="[placeholder]users.placeholders.enterPassword"
                                            placeholder="••••••••" />
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>


                            <div class="mt-10">
                                <button type="submit" class="btn btn-primary me-3"
                                    data-i18n="common.saveChanges">Сохранить изменения</button>
                                <button type="reset" class="btn btn-label-secondary"
                                    data-i18n="common.cancel">Отмена</button>
                            </div>

                        </div>
                        <!-- /Account -->
                    </form>
                </div>

            </div>
        </div>
    </div>

    <div>
        <th:block layout:fragment="page_js">
            <script th:inline="javascript">
                window.contextPath = '[[@{/}]]'.replaceAll('"', '').replace(/\/$/, '');
                window.defaultAvatarPath = '[[@{/assets/img/avatars/14.png}]]';
                console.log(window.defaultAvatarPath);
            </script>

            <script>
                // Переводим статические элементы после загрузки i18next
                function translateElements() {
                    document.querySelectorAll('[data-i18n]').forEach(element => {
                        const key = element.getAttribute('data-i18n');
                        if (key.startsWith('[placeholder]')) {
                            const placeholderKey = key.replace('[placeholder]', '');
                            element.placeholder = i18next.t(placeholderKey);
                        } else if (key.startsWith('[aria-label]')) {
                            const ariaKey = key.replace('[aria-label]', '');
                            element.setAttribute('aria-label', i18next.t(ariaKey));
                        } else {
                            const translatedText = i18next.t(key);
                            if (element.tagName.toLowerCase() === 'title') {
                                document.title = translatedText;
                            }
                            element.textContent = translatedText;
                        }
                    });
                }


                document.addEventListener('DOMContentLoaded', function () {
                    if (typeof i18next !== 'undefined') {
                        i18next.on('initialized', translateElements);
                        i18next.on('languageChanged', translateElements);
                        if (i18next.isInitialized) {
                            translateElements();
                        }
                    }
                });

                $(document).ready(function () {
                    // Variables
                    let isEditMode = false;
                    let chairmanId = null;
                    let currentChairman = null;

                    // Form elements
                    const chairmanForm = document.getElementById('formAccountSettings');
                    const chairmanIdField = document.getElementById('chairmanId');
                    const avatarImg = document.getElementById('uploadedAvatar');
                    const fileInput = document.getElementById('photo');
                    const resetBtn = document.querySelector('.account-image-reset');

                    // Form fields
                    const fields = {
                        firstName: document.getElementById('firstName'),
                        lastName: document.getElementById('lastName'),
                        middleName: document.getElementById('middleName'),
                        phone: document.getElementById('phone'),
                        email: document.getElementById('email'),
                        status: document.getElementById('status'),
                        login: document.getElementById('login'),
                        password: document.getElementById('password')
                    };

                    // Initialize page
                    init();

                    async function init() {
                        try {
                            const path = window.location.pathname;
                            if (path.includes('/edit/')) {
                                isEditMode = true;
                                chairmanId = path.split('/edit/')[1];
                                await loadChairmanData();
                            }

                            await loadStatuses();

                            // Setup event listeners
                            setupEventListeners();

                            // Слушатель смены языка для обновления меток статусов
                            if (typeof i18next !== 'undefined') {
                                i18next.on('languageChanged', function () {
                                    updateStatusLabels();
                                });
                            }

                            // If edit mode, populate form
                            if (isEditMode && currentChairman) {
                                await populateForm(currentChairman);
                            }

                        } catch (error) {
                            console.error('Initialization error:', error);
                            showNotification('Ошибка при инициализации страницы', 'error');
                        }
                    }

                    async function loadChairmanData() {
                        try {
                            const response = await fetch(window.contextPath + `/chairmen/getChairman/${chairmanId}`);
                            if (response.ok) {
                                currentChairman = await response.json();
                            } else {
                                throw new Error('Председатель не найден');
                            }
                        } catch (error) {
                            console.error('Error loading chairman:', error);
                            showNotification('Ошибка при загрузке данных председателя', 'error');
                        }
                    }

                    async function loadStatuses() {
                        try {
                            const response = await fetch(window.contextPath + '/chairmen/getStatuses');
                            if (response.ok) {
                                const statuses = await response.json();
                                populateStatusSelect(statuses);
                            }
                        } catch (error) {
                            console.error('Error loading statuses:', error);
                        }
                    }

                    function populateStatusSelect(statuses) {
                        const statusSelect = fields.status;

                        // Получаем placeholder с учетом i18n
                        const placeholderText = typeof i18next !== 'undefined'
                            ? i18next.t('chairmen.placeholders.selectStatus')
                            : 'Выберите статус';
                        statusSelect.innerHTML = `<option value="">${placeholderText}</option>`;

                        // Маппинг статусов на i18n ключи
                        const statusI18nKeys = {
                            'NEW': 'chairmen.statusOptions.new',
                            'ACTIVE': 'chairmen.statusOptions.active',
                            'DEACTIVATED': 'chairmen.statusOptions.deactivated',
                            'BLOCKED': 'chairmen.statusOptions.blocked'
                        };

                        // Fallback значения на случай отсутствия i18n
                        const statusFallbacks = {
                            'NEW': 'Новый',
                            'ACTIVE': 'Активный',
                            'DEACTIVATED': 'Деактивирован',
                            'BLOCKED': 'Заблокирован'
                        };

                        statuses.forEach(status => {
                            const option = document.createElement('option');
                            option.value = status;

                            // Используем i18n если доступен, иначе fallback
                            if (typeof i18next !== 'undefined' && statusI18nKeys[status]) {
                                option.textContent = i18next.t(statusI18nKeys[status]);
                                option.setAttribute('data-i18n', statusI18nKeys[status]);
                            } else {
                                option.textContent = statusFallbacks[status] || status;
                            }

                            statusSelect.appendChild(option);
                        });
                    }

                    function updateStatusLabels() {
                        if (typeof i18next === 'undefined') return;

                        const statusSelect = fields.status;
                        const currentValue = statusSelect.value;

                        // Обновляем все опции с data-i18n атрибутом
                        Array.from(statusSelect.options).forEach(option => {
                            const i18nKey = option.getAttribute('data-i18n');
                            if (i18nKey) {
                                option.textContent = i18next.t(i18nKey);
                            }
                        });

                        // Восстанавливаем выбранное значение
                        if (currentValue) {
                            statusSelect.value = currentValue;
                        }
                    }

                    async function populateForm(chairman) {
                        try {
                            console.log('Populating form with chairman:', chairman);

                            // Заполнение простых полей
                            if (chairman.firstName) fields.firstName.value = chairman.firstName;
                            if (chairman.lastName) fields.lastName.value = chairman.lastName;
                            if (chairman.middleName) fields.middleName.value = chairman.middleName;
                            if (chairman.phone) fields.phone.value = chairman.phone;
                            if (chairman.email) fields.email.value = chairman.email;
                            if (chairman.status) fields.status.value = chairman.status;
                            if (chairman.login) fields.login.value = chairman.login;

                            // Set chairman ID
                            if (chairmanIdField) chairmanIdField.value = chairman.id;

                            // Обработка аватара
                            if (chairman.photo && chairman.photo.trim() !== '' && chairman.photo !== 'default_photo.jpg') {
                                if (chairman.photo.startsWith('http') || chairman.photo.startsWith('/')) {
                                    avatarImg.src = (window.contextPath || '') + '/' + chairman.photo;
                                } else {
                                    avatarImg.src = (window.contextPath || '') + '/' + chairman.photo;
                                }
                            } else {
                                avatarImg.src = (window.contextPath || '') + '/assets/img/avatars/1.png';
                            }

                            console.log('Form populated successfully');

                        } catch (error) {
                            console.error('Error populating form:', error);
                            showNotification('Ошибка при заполнении формы', 'error');
                        }
                    }

                    function setupEventListeners() {
                        // Form submit
                        chairmanForm.addEventListener('submit', handleFormSubmit);

                        // File upload
                        if (fileInput) {
                            fileInput.addEventListener('change', handleFileUpload);
                        }

                        // Reset avatar
                        if (resetBtn) {
                            resetBtn.addEventListener('click', resetAvatar);
                        }

                        // Cancel button
                        const cancelBtn = document.querySelector('button[type="reset"]');
                        if (cancelBtn) {
                            cancelBtn.addEventListener('click', function (e) {
                                e.preventDefault();
                                window.history.back();
                            });
                        }
                    }

                    async function handleFormSubmit(e) {
                        e.preventDefault();

                        try {
                            // Show loading state
                            const submitBtn = chairmanForm.querySelector('button[type="submit"]');
                            const originalText = submitBtn.textContent;
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'Сохранение...';

                            // Prepare form data
                            const formData = new FormData(chairmanForm);

                            // Debug: Log form data
                            console.log('Form data being sent:');
                            for (let [key, value] of formData.entries()) {
                                console.log(`${key}: ${value}`);
                            }

                            // API endpoint and method
                            const url = isEditMode ? window.contextPath + `/chairmen/${chairmanId}` : window.contextPath + '/chairmen/create';
                            const method = isEditMode ? 'PUT' : 'POST';

                            console.log(`Sending ${method} request to ${url}`);

                            const response = await fetch(url, {
                                method: method,
                                body: formData
                            });

                            if (response.ok) {
                                const result = await response.json();
                                console.log('Success response:', result);
                                showNotification(
                                    isEditMode ? 'Председатель успешно обновлен' : 'Председатель успешно создан',
                                    'success'
                                );

                                // Redirect to chairman list
                                setTimeout(() => {
                                    window.location.href = window.contextPath + '/chairmen';
                                }, 1500);
                            } else {
                                const errorData = await response.json();
                                console.error('Error response:', errorData);
                                handleValidationErrors(errorData);
                            }

                        } catch (error) {
                            console.error('Form submission error:', error);
                            showNotification('Ошибка при сохранении данных', 'error');
                        } finally {
                            // Restore button state
                            const submitBtn = chairmanForm.querySelector('button[type="submit"]');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    }

                    function handleValidationErrors(errorData) {
                        // Clear previous errors
                        clearValidationErrors();

                        if (errorData.fieldErrors) {
                            Object.keys(errorData.fieldErrors).forEach(fieldName => {
                                const field = fields[fieldName];
                                if (field) {
                                    const errorContainer = field.parentElement.querySelector('.invalid-feedback');
                                    if (errorContainer) {
                                        field.classList.add('is-invalid');
                                        errorContainer.textContent = errorData.fieldErrors[fieldName];
                                    }
                                }
                            });
                        } else {
                            showNotification(errorData.message || 'Ошибка валидации данных', 'error');
                        }
                    }

                    function clearValidationErrors() {
                        Object.values(fields).forEach(field => {
                            if (field) {
                                field.classList.remove('is-invalid');
                                const errorContainer = field.parentElement.querySelector('.invalid-feedback');
                                if (errorContainer) {
                                    errorContainer.textContent = '';
                                }
                            }
                        });
                    }

                    function handleFileUpload(e) {
                        const file = e.target.files[0];
                        if (file) {
                            // Validate file type
                            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                            if (!allowedTypes.includes(file.type)) {
                                showNotification('Разрешены только изображения (JPG, PNG, GIF)', 'error');
                                e.target.value = '';
                                return;
                            }

                            // Validate file size (800KB)
                            if (file.size > 800 * 1024) {
                                showNotification('Размер файла не должен превышать 800KB', 'error');
                                e.target.value = '';
                                return;
                            }

                            // Preview image
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                avatarImg.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    }

                    function resetAvatar() {
                        avatarImg.src = (window.contextPath || '') + '/assets/img/avatars/1.png';
                        if (fileInput) {
                            fileInput.value = '';
                        }
                    }

                    function showNotification(message, type = 'info') {
                        // Используем toast.js для уведомлений
                        let title = '';
                        switch (type) {
                            case 'error':
                                title = 'Ошибка';
                                break;
                            case 'success':
                                title = 'Успех';
                                break;
                            case 'warning':
                                title = 'Предупреждение';
                                break;
                            default:
                                title = 'Информация';
                        }
                        showToast(type, title, message);
                    }
                });
            </script>

        </th:block>
    </div>



</body>

</html>